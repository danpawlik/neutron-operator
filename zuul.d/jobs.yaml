---
- job:
    name: cifmw-podified-multinode-edpm-base-crc-future
    parent: base-future-extracted-crc
    timeout: 10800
    attempts: 1
    nodeset: centos-9-medium-centos-9-crc-extracted-2.30-3xl
    irrelevant-files: &ir_files
      - .*/*.md
      - ^.github/.*$
      - ^LICENSE$
      - ^OWNERS$
      - ^OWNERS_ALIASES$
      - ^PROJECT$
      - ^README.md$
      - ^renovate.json$
      - ^kuttl-test.yaml$
      - molecule/.*
      - molecule-requirements.txt
      - .github/workflows
      - docs/.*
      - contribute/.*
      - roles/.*/molecule/.*
      # ci-framework
      - .readthedocs.yaml
      - roles/dlrn_report
      - roles/dlrn_promote
      - roles/devscripts
      # Other openstack operators
      - containers/ci
      - .ci-operator.yaml
      - .dockerignore
      - .gitignore
      - .golangci.yaml
      - .pre-commit-config.yaml
      - tests?\/functional
      # openstack-ansibleee-operator
      - examples
      - mkdocs.yml
    required-projects: &multinode_edpm_rp
      - openstack-k8s-operators/ci-framework
      - openstack-k8s-operators/dataplane-operator
      - openstack-k8s-operators/install_yamls
      - openstack-k8s-operators/infra-operator
      - openstack-k8s-operators/openstack-baremetal-operator
      - openstack-k8s-operators/openstack-must-gather
      - openstack-k8s-operators/openstack-operator
      - openstack-k8s-operators/repo-setup
      - openstack-k8s-operators/edpm-ansible
    roles: &multinode_edpm_roles
      - zuul: github.com/openstack-k8s-operators/ci-framework
    pre-run:
      - playbooks/test.yaml
#    pre-run: &multinode_edpm_pre_run
#      - ci/playbooks/multinode-customizations.yml
#      - ci/playbooks/e2e-prepare.yml
#      - ci/playbooks/dump_zuul_data.yml
#    post-run: &multinode_edpm_post_run
#      - ci/playbooks/e2e-collect-logs.yml
#      - ci/playbooks/collect-logs.yml
#      - ci/playbooks/multinode-autohold.yml
    vars: &multinode_edpm_vars
      zuul_log_collection: true
      registry_login_enabled: true
      push_registry: quay.rdoproject.org
      quay_login_secret_name: quay_nextgen_zuulgithubci
      cifmw_artifacts_crc_sshkey: "~/.ssh/id_cifw"
      cifmw_openshift_user: kubeadmin
      cifmw_openshift_password: "123456789"
      cifmw_openshift_api: api.crc.testing:6443
      cifmw_openshift_kubeconfig: "{{ ansible_user_dir }}/.crc/machines/crc/kubeconfig"
      cifmw_openshift_skip_tls_verify: true
      cifmw_use_libvirt: false
      cifmw_zuul_target_host: controller
      crc_ci_bootstrap_cloud_name: "{{ nodepool.cloud | replace('-nodepool-tripleo','') }}"
      crc_ci_bootstrap_networking:
        networks:
          default:
            mtu: "{{ ('ibm' in nodepool.cloud) | ternary('1440', '1500') }}"
            router_net: "{{ ('ibm' in nodepool.cloud) | ternary('hostonly', 'public') }}"
            range: 192.168.122.0/24
          internal-api:
            vlan: 20
            range: 172.17.0.0/24
          storage:
            vlan: 21
            range: 172.18.0.0/24
          tenant:
            vlan: 22
            range: 172.19.0.0/24
        instances:
          controller:
            networks:
              default:
                ip: 192.168.122.11
          crc:
            networks:
              default:
                ip: 192.168.122.10
              internal-api:
                ip: 172.17.0.5
              storage:
                ip: 172.18.0.5
              tenant:
                ip: 172.19.0.5
          compute-0:
            networks:
              default:
                ip: 192.168.122.100
              internal-api:
                ip: 172.17.0.100
                config_nm: false
              storage:
                ip: 172.18.0.100
                config_nm: false
              tenant:
                ip: 172.19.0.100
                config_nm: false


- job:
    name: podified-multinode-edpm-deployment-crc-future
    parent: cifmw-podified-multinode-edpm-base-crc-future
#    vars:
#      cifmw_extras:
#        - '@scenarios/centos-9/multinode-ci.yml'
    run:
      - playbooks/test.yaml
#      - ci/playbooks/edpm/run.yml

- job:
    name: neutron-operator-tempest-multinode
    parent: podified-multinode-edpm-deployment-crc-future
    dependencies: ["openstack-k8s-operators-content-provider"]
    irrelevant-files:
      - .*/*.md
      - ^.github/.*$
      - .ci-operator.yaml
      - .dockerignore
      - .gitignore
      - .golangci.yaml
      - .pre-commit-config.yaml
      - .prow_ci.env
      - ^LICENSE.*$
      - ^OWNERS$
      - ^OWNERS_ALIASES$
      - ^PROJECT$
      - .*go.(mod|sum|work).*
      - ^kuttl-test.yaml$
      - ^renovate.json$
      - ^config/samples/.*$
      - ^docs?/.*
      - ^hack/.*$
      - ^tests?/functional/.*$
      - ^tests?/kuttl/.*$
      - ^zuul.d/(?!(project)).*\.yaml
    vars:
      cifmw_tempest_container: openstack-tempest-all
      cifmw_tempest_tempestconf_profile:
          overrides:
            compute-feature-enabled.vnc_console: true
            validation.run_validation: true
            # NOTE(gibi): This is a WA to force the publicURL as otherwise
            # tempest gets configured with adminURL and that causes test
            # instability.
            identity.v3_endpoint_type: public
            identity.v2_admin_endpoint_type: public
      cifmw_tempest_tests_allowed:
        - neutron_tempest_plugin.api
        - neutron_tempest_plugin.scenario
        # To check metadata with and without config drive
        - tempest.scenario.test_server_basic_ops.TestServerBasicOps.test_server_basic_ops
      cifmw_tempest_tests_skipped:
        # https://review.opendev.org/892839
        - neutron_tempest_plugin.scenario.test_mtu.NetworkWritableMtuTest
        # missing https://review.opendev.org/882818 in antelope
        - test_qos_dscp_create_and_update
        # Limit job runtime
        - NetworkSecGroupTest
      change_machineconfigpool: true
